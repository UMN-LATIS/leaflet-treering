<html>
  <head>

    <link rel="stylesheet" href="../assets/font-awesome/css/font-awesome.css">

    <script src="https://cdn.plot.ly/plotly-2.0.0-rc.2.min.js"></script>
    <script src="../assets/leaflet/dist/leaflet.js"></script>

    <style>
      #color {
        margin-left: 4%;
      }

      #files {
        margin-left: 4%;
        display: block;
      }

      p {
        margin: 0;
        margin-top: 2px;
        font-family: sans-serif;
        font-size: 12px;
      }

      span {
        font-family: sans-serif;
        font-size: 12px;
      }

      i {
        width: 20px;
        height: 20px;
        margin-left: 5px;
      }

      .colorInput {
        margin: 0;
        margin-left: 20%;
        padding: 0;
        border: 0;
        width: 20px;
        height: 20px;
      }

    </style>

  </head>
  <body>

    <div id='plot' style='width:100%; height:90%'></div>
    <div id='files' style='width:100%;'>
      <p id='instructions'>Files must be .CSV, .JSON, RWL format, tab demlimited, or space demlimited.</p>
      <p> Edit selected files: </p>
    </div>
    <div id='color' style='width: 100%;'></div>

    <script id="script">
      var div = document.getElementById('plot');

      function createPlot (data, layout, config) {
        var defaultColors = [
          '#1f77b4',  // muted blue
          '#ff7f0e',  // safety orange
          '#2ca02c',  // cooked asparagus green
          '#d62728',  // brick red
          '#9467bd',  // muted purple
          '#8c564b',  // chestnut brown
          '#e377c2',  // raspberry yogurt pink
          '#7f7f7f',  // middle gray
          '#bcbd22',  // curry yellow-green
          '#17becf'   // blue-teal
        ];

        k = 0
        data.forEach((obj, i) => {
          if (k > 9) { // loop i over default colors
            k = 0;
          }
          obj.line = { color: defaultColors[k] }
          k++;
        });


        // main plot
        Plotly.newPlot(div, data, layout, config);

        /* To build:
         - Custom standard colors (10?)
         - Drop down & highlight inputted data sets
        */

        var colorDiv = document.getElementById('color');
        for (child of colorDiv.childNodes) {
          colorDiv.removeChild(child);
        }

        var inputTable = document.createElement('table');

        // create color inputs to change line colors
        data.forEach((set, i) => {
          let inputRow = inputTable.insertRow(-1);

          let span = document.createElement('span');
          span.innerHTML = set.name;

          let input = document.createElement('input');
          input.className = 'colorInput';
          input.type = 'color';
          input.value = set.line.color;
          input.addEventListener('change', () => {
            colorChange = {
              'line.color': input.value,
            }
            Plotly.restyle(div, colorChange, [i]);
          })

          var nameCell = inputRow.insertCell(-1);
          nameCell.appendChild(span);
          var colorCell = inputRow.insertCell(-1);
          colorCell.appendChild(input);

          if (i > 0) { // add option to remove specfic cores, do not allow removal of base tree core
            let deleteBtn = document.createElement('i');
            deleteBtn.className = 'fa fa-times';
            deleteBtn.setAttribute('aria-hidden', 'true');

            deleteBtn.addEventListener('click', () => {
              data.forEach((obj, i) => {
                if (obj.name == span.innerHTML) { // if data name = name of span in same table row
                  data.splice(i, 1); // remove data & re-render plot

                  // remove file from input
                  let dt = new DataTransfer()
                  let files = document.getElementById('fileInput').files;
                  for (file of files) {
                    let nameLength = span.innerHTML.length;
                    let nickname = file.name.slice(0, nameLength);
                    console.log(nickname, span.innerHTML)

                    if (nickname != span.innerHTML) {
                      dt.items.add(file)
                    }
                  }
                  document.getElementById('fileInput').files = dt.files;

                  createPlot (data, layout, config);
                }
              });
            });

            var deleteCell = inputRow.insertCell(-1);
            deleteCell.appendChild(deleteBtn);
          };
        })

        colorDiv.appendChild(inputTable);
      };

    </script>

  </body>
</html>
